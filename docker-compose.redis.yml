services:
  redis:
    image: redis:7-alpine
    container_name: ${REDIS_CONTAINER_NAME:-tdsqueue-redis}
    command: ["redis-server", "--appendonly", "yes"]
    ports:
      - "${REDIS_PORT:-6379}:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 20

  tdsqueue-proxy:
    build:
      context: .
      dockerfile: Dockerfile
    image: ${TDS_PROXY_IMAGE:-tdsqueue-proxy:latest}
    container_name: ${TDS_PROXY_CONTAINER_NAME_REDIS:-tdsqueue-proxy-redis}
    depends_on:
      redis:
        condition: service_healthy
    environment:
      DOTNET_ENVIRONMENT: ${DOTNET_ENVIRONMENT:-Production}
      TDS_PROXY_ADMIN_TOKEN: ${TDS_PROXY_ADMIN_TOKEN:-change-me}
      Proxy__QueueEngine: ${PROXY_QUEUE_ENGINE:-Redis}
      Proxy__TargetHost: ${PROXY_TARGET_HOST:-host.docker.internal}
      Proxy__TargetPort: ${PROXY_TARGET_PORT:-1433}
      Proxy__Redis__Configuration: ${PROXY_REDIS_CONFIGURATION:-redis:6379,abortConnect=false}
      Proxy__Redis__QueueKey: ${PROXY_REDIS_QUEUE_KEY:-tdsqueue:requests:docker}
      Proxy__Redis__ProcessingQueueKey: ${PROXY_REDIS_PROCESSING_QUEUE_KEY:-tdsqueue:requests:docker:processing}
      Observability__HealthPort: ${OBS_HEALTH_PORT:-18080}
      Observability__EnableAdminEndpoint: ${OBS_ENABLE_ADMIN_ENDPOINT:-true}
      Observability__EnableOtlpExporter: ${OBS_ENABLE_OTLP_EXPORTER:-false}
    ports:
      - "${PROXY_LISTEN_PORT:-14330}:14330"
      - "${OBS_HEALTH_PORT:-18080}:18080"
    extra_hosts:
      - "host.docker.internal:host-gateway"
